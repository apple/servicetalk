name: PR Builder
permissions:
  contents: read
on:
  pull_request:
    branches: [ main, '0.41', '0.42' ]
    paths-ignore:
      - 'docs/**'
      - 'scripts/**'
      - '.github/pull_request_template.md'
      - '.gitignore'
      - 'gradlew'
      - 'gradlew.bat'
      - '**.adoc'
      - '**.txt'
jobs:
  build:
    name: JDK ${{ matrix.java }} ${{ matrix.os_label }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        java: [ 8, 11, 17, 21, 25 ]
        os: [ ubuntu-latest ]
        os_label: [ ubuntu ]
        include:
          - java: 11
            os: [self-hosted, macos, general]
            os_label: macos
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: |
            17
            ${{ matrix.java }}
          distribution: 'zulu'
          cache: 'gradle'
      - name: Print JDK Version
        run: java -version
      - name: Debug macOS TCP/Socket Configuration
        if: runner.os == 'macOS'
        run: |
          echo "=== OS Version ==="
          sw_vers
          uname -a

          echo ""
          echo "=== TCP/Socket Kernel Parameters ==="
          sysctl kern.ipc.somaxconn
          sysctl kern.ipc.soqlimitcompat 2>/dev/null || echo "soqlimitcompat not available"
          sysctl kern.ipc.soqlencomp 2>/dev/null || echo "soqlencomp not available"

          echo ""
          echo "=== All Socket-Related Sysctls ==="
          sysctl -a 2>/dev/null | grep -E "kern\.ipc\.(so|tcp)" | sort

          echo ""
          echo "=== Java Version ==="
          java -version

          echo ""
          echo "=== Hardware Info ==="
          sysctl hw.ncpu hw.physicalcpu hw.memsize

          echo ""
          echo "=== Virtualization Check ==="
          sysctl -a 2>/dev/null | grep -i virtual || echo "No virtualization sysctls found"
          system_profiler SPHardwareDataType 2>/dev/null | grep -E "(Model|Chip|Memory|Cores)" || true
      - name: Set Gradle Environment
        run: echo "GRADLE_OPTS=-Dorg.gradle.java.home=$JAVA_HOME_17_${{ runner.arch }}" >> "$GITHUB_ENV"
      - name: Make gradlew Executable
        run: chmod +x gradlew
      - name: Clean Gradle project
        run: ./gradlew --parallel clean
      # https://github.community/t/error-the-paging-file-is-too-small-for-this-operation-to-complete/17141
      - name: Configure Windows Pagefile
        if: ${{ runner.os == 'Windows' }}
        # v1.2
        uses: al-cheb/configure-pagefile-action@v1.5
        with:
          minimum-size: 8GB
          maximum-size: 16GB
      - name: Build and Test (Linux)
        if: runner.os == 'Linux'
        env:
          JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF-8
        run:  sudo -E env "PATH=$PATH" bash -c "ulimit -l 65536 && ulimit -a && ./gradlew --no-daemon --parallel test"
      - name: Build and Test (non-Linux)
        if: runner.os != 'Linux'
        env:
          JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF-8
        run: ./gradlew --no-daemon --parallel test
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-${{ matrix.os_label }}-${{ matrix.java }}
          path: '**/build/test-results/test/TEST-*.xml'

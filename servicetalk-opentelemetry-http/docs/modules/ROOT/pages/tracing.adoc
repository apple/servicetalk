// Configure {source-root} values based on how this document is rendered: on GitHub or not
ifdef::env-github[]
:source-root:
endif::[]
ifndef::env-github[]
ifndef::source-root[:source-root: https://github.com/apple/servicetalk/blob/{page-origin-refname}]
endif::[]

= OpenTelemetry HTTP Tracing Guide

This guide provides detailed information on using OpenTelemetry HTTP tracing filters with ServiceTalk.

== Quick Start

=== Prerequisites

Before using OpenTelemetry tracing, ensure you have:

* OpenTelemetry Java libraries in your classpath
* `servicetalk-opentelemetry-asynccontext` module for context propagation
* `servicetalk-opentelemetry-http` module for HTTP tracing filters

=== Basic Client Setup

[source,java]
----
// Example client configuration
HttpClient client = HttpClients.forSingleAddress("example.com", 80)
    .appendClientFilter(new OpenTelemetryHttpRequesterFilter.Builder()
        .componentName("my-client")
        .build())
    .build();
----

=== Basic Server Setup

[source,java]
----
// Example server configuration
HttpServerBuilder.forAddress(localAddress(0))
    .appendNonOffloadingServiceFilter(new OpenTelemetryHttpServiceFilter.Builder()
        .build())
    .listen(service);
----

== Advanced Configuration

=== Capturing Custom Headers

[source,java]
----
// Capture specific request and response headers as span attributes
OpenTelemetryHttpRequesterFilter filter = new OpenTelemetryHttpRequesterFilter.Builder()
    .componentName("my-client")
    .capturedRequestHeaders(Arrays.asList("x-custom-header", "authorization"))
    .capturedResponseHeaders(Arrays.asList("x-response-id", "content-type"))
    .build();
----

=== Enabling Metrics

[source,java]
----
// Enable OpenTelemetry metrics collection
OpenTelemetryHttpServiceFilter filter = new OpenTelemetryHttpServiceFilter.Builder()
    .enableMetrics(true)
    .build();
----

== Filter Ordering Guidelines

=== Client Filters
When using multiple filters on clients, place the OpenTelemetry filter appropriately in the chain:

[source,java]
----
HttpClient client = HttpClients.forSingleAddress("example.com", 80)
    .appendClientFilter(loggingFilter)  // Before tracing for proper context
    .appendClientFilter(openTelemetryFilter)  // Tracing filter
    .appendClientFilter(retryFilter)  // After tracing
    .build();
----

=== Server Filters
For servers, use non-offloading filters for proper context propagation:

[source,java]
----
HttpServerBuilder.forAddress(localAddress(0))
    .appendNonOffloadingServiceFilter(openTelemetryFilter)  // First for context
    .appendNonOffloadingServiceFilter(autoDrainingFilter)  // After tracing
    .appendServiceFilter(exceptionMapperFilter)  // After tracing
    .listen(service);
----

== Context Propagation

OpenTelemetry context is automatically propagated through:

* HTTP headers using standard OpenTelemetry propagation format
* ServiceTalk's async context system via `servicetalk-opentelemetry-asynccontext`
* Thread boundaries during async operations

== gRPC Support

The HTTP tracing filters provide specialized support for gRPC over HTTP/2:

* Automatic detection of gRPC requests
* gRPC-specific span naming and attributes
* Proper status code mapping

== Troubleshooting

=== Common Issues

**Context Not Propagating**
Ensure `servicetalk-opentelemetry-asynccontext` is on the classpath and the filter is properly ordered.

**Missing Spans**
Verify OpenTelemetry is properly configured and the global OpenTelemetry instance is set.

**Performance Impact**
Consider disabling metrics if not needed, as they add overhead to request processing.

== Examples

For complete working examples, see the OpenTelemetry examples in the ServiceTalk examples module.

== Related Documentation

* xref:{page-version}@servicetalk-opentelemetry-asynccontext::index.adoc[OpenTelemetry Async Context]
* xref:{page-version}@servicetalk-concurrent-api::async-context.adoc[ServiceTalk Asynchronous Context]
* https://opentelemetry.io/docs/instrumentation/java/[OpenTelemetry Java Documentation]